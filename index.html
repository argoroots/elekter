<!doctype html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Elektri hind</title>
    <style>
        @tailwind base;
        @tailwind components;
        @tailwind utilities;

        html, body {
            @apply h-full;
            @apply bg-white;
            @apply select-none;
            @apply cursor-default;
            color: rgb(117, 117, 117);
        }
    </style>
</head>
<body class="h-full h-full">
    <div class="container my-12 mx-auto px-2 flex flex-col gap-20 antialiased">
        <h1 class="self-center w-max text-2xl text-center font-bold text-stone-900/80 tracking-wide">
            Elektri hind
            <span class="block italic text-right text-sm font-thin">by <a class="hover:underline" href="mailto:argo@roots.ee?subject=Elektri hind">Argo Roots</a></span>
        </h1>
        <div id="chart" class="h-96"></div>
        <div id="lowest" class="grid grid-cols-1 sm:grid-cols-4 gap-8 justify-between"></div>
    </div>

    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
        google.charts.load('current', { packages: ['bar'] })
        google.charts.setOnLoadCallback(async function () {
            const response = await fetch('https://api.roots.ee/elekter')
            const responseJson = await response.json()
            const prices = responseJson.map((x) => [
                x.at(3).toString(),
                x.at(7) * 100,
                x.at(6) * 100,
                x.at(5) * 100,
                x.at(4) * 100
            ])

            const lowest = [
                ['1h', ...findLowestTimeSpan(prices, 1)],
                ['2h', ...findLowestTimeSpan(prices, 2)],
                ['3h', ...findLowestTimeSpan(prices, 3)],
                ['4h', ...findLowestTimeSpan(prices, 4)],
            ]

            console.log(lowest);

            const data = google.visualization.arrayToDataTable([
                [
                    'tund',
                    'aktsiis',
                    'taastuvenergiatasu',
                    'edastustasu',
                    'elekter'
                ],
                ...prices
            ])

            const options = {
                isStacked: true,
                bars: 'vertical',
                legend: {
                    position: 'none'
                },
                axes: {
                    x: { 0: { label: ''} },
                    y: { 0: { label: ''} }
                },
                vAxis: {
                    format: '0.00s'
                }
            }
            const chartDiv = document.getElementById('chart')
            const lowestDiv = document.getElementById('lowest')

            new google.charts.Bar(chartDiv).draw(data, google.charts.Bar.convertOptions(options))
            lowestDiv.innerHTML = lowest.map((x) => `<div class="flex flex-col gap-2 items-center"><div class="font-bold">${x.at(0)}</div>${x.at(1)}:00 â€“ ${x.at(2)}:00<div>${x.at(3).toFixed(2)}s</div></div>`).join('')
        })

        function findLowestTimeSpan(prices, span) {
            const pricesSum = prices.map((x) => x.at(1) + x.at(2) + x.at(3) + x.at(4))

            let lowestSum = Infinity
            let lowestSumIndex = -1

            for (let i = 0; i < pricesSum.length - span + 1; i++) {
                const sum = pricesSum.slice(i, i + span).reduce((acc, val) => acc + val, 0)

                if (sum < lowestSum) {
                    lowestSum = sum
                    lowestSumIndex = i
                }
            }

            return [prices[lowestSumIndex].at(0), prices[lowestSumIndex + span].at(0), lowestSum / span]
        }
    </script>
</body>
</html>